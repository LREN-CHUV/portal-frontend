<div ng-if="!loaded">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="panel">
        <div class="panel-heading">
          <h3>Please wait</h3>
        </div>
        <div class="panel-body">
          We are loading the data corresponding to your model.
        </div>
      </div>
    </div>
  </div>
</div>
<div ng-cloak ng-if="loaded">

  <div class="row">
    <div class="col-xs-12">
      <div class="panel" style="margin-bottom: 20px">
        <div class="panel-heading">
          <h3 ng-if="model">
            Run an Experiment on
            <a ui-sref="models-edit({slug: model.slug, isCopy: false})" ng-bind="model.title"></a>
            <other-experiments model_slug="model.slug"></other-experiments>
          </h3>
          <h3 ng-if="!model">
            Run an Experiment on &lt;Unsaved Model&gt;
            <button class="btn btn-primary col-bottom" ng-click="save_model()">Save Model</button>
          </h3>
        </div>
      </div>

      <div class="row">

        <div class="col-sm-3">
          <div class="method-panel panel">
            <div class="panel-heading">
              Available Methods
            </div>
            <div class="panel-body">

              <div ng-if="!ml_methods.length">
                <h4>Note:</h4>
                <p>
                  No method available at the moment...
                </p>
              </div>

              <uib-accordion ng-if="ml_methods.length" close-others="false">

                  <div ng-if="federationmode" uib-accordion-group heading="Distributed Algorithms" ng-init="acc_dist.open = true" is-open="acc_dist.open" ng-click="!acc_dist.open">
                      <p ng-repeat="method in ml_methods | filter:{environment:'Exareme'}  | orderBy:'-label'">
                        <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="show_training_validation(method)" ng-bind="method.label">
                        </button>
                        <br>
                        <br>
                      </p>
                    </div>

                <div uib-accordion-group heading="Statistical Analysis" ng-init="acc_stats.open = true" is-open="acc_stats.open" ng-click="!acc_stats.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'statistics', environment:'!Exareme'}  | orderBy:'-label'">
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="show_training_validation(method)" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>

                <div uib-accordion-group heading="Features Extraction" ng-init="acc_fe.open = true" is-open="acc_fe.open" ng-click="!acc_fe.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'features_extraction', environment:'!Exareme'}  | orderBy:'-label'">
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="show_training_validation(method)" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>

                <div uib-accordion-group heading="Predictive Model" ng-init="acc_pm.open = true" is-open="acc_pm.open" ng-click="!acc_pm.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'predictive_model', environment:'!Exareme'}  | orderBy:'-label'">
                    <span class="label label-default" ng-if="method.nyi">Coming soon</span>
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="show_training_validation(method)" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>

              </uib-accordion>
            </div>
          </div>
        </div>

        <div class="col-sm-6">
          <uib-accordion close-others="false">

            <div uib-accordion-group is-open="true">
              <uib-accordion-heading>
                Your Experiment
              </uib-accordion-heading>

              <div ng-if="shared.chosen_method.parameters.length" class="form-group">

                <h4>
                    <span class="chosen-method">{{ shared.chosen_method.label }}</span>
                </h4>
                <div ng-repeat="parameter in shared.chosen_method.parameters" class="form-inline">
                  <label for="{{parameter.name}}">
                    <b ng-bind="parameter.label + ': '"></b>
                  </label>
                  <div ng-switch on="parameter.type">
                    <div ng-switch-when="int">
                      <input type="number" step="1" id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value"
                             value="{{shared.method_parameters[$index].value}}" ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parseInt(parameter.default_value)}">
                    </div>
                    <div ng-switch-when="real">
                      <input type="number" step="0.1" id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value"
                             value="{{shared.method_parameters[$index].value}}" ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}">
                    </div>
                    <div ng-switch-when="number">
                        <input type="number" step="0.1" id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value"
                               value="{{shared.method_parameters[$index].value}}" ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}">
                      </div>
                    <div ng-switch-when="enumeration">
                      <select id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value" ng-options="value for value in parameter.values"
                              ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}"></select>
                    </div>
                    <div ng-switch-default>
                      <p ng-bind="{{shared.chosen_method.parameters | json}}"></p>
                      <input id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value" value="{{shared.method_parameters[$index].value}}"
                             ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}">
                    </div>
                  </div>
                  <p ng-bind="parameter.description"></p>
                </div>
              </div>
              <div ng-if="shared.chosen_method && !shared.chosen_method.parameters.length">
                There are no parameters for
                <span ng-bind="shared.chosen_method.label"></span>.
              </div>

              <div ng-if="!shared.chosen_method && shared.experiment_configuration.length == 0">
                  <p>
                    Pick a Method on the left and add it here to create an experiment
                  </p>
                </div>

              <br>
              <button class="btn btn-primary pull-right" ng-class="{'disabled': !shared.chosen_method || method_already_configured() || configuration_not_valid()}"
                      ng-click="add_to_experiment()">
                Add method
              </button>

              <br><br>

              <div>
                <algorithm-runner></algorithm-runner>
              </div>
            </div>
          </uib-accordion>

          <!-- ng-show instead of ng-if because I don't want the inner directives to be destroyed  when unpicking the method -->
          <form class="row">

            <div class="col-xs-12">

              <uib-accordion close-others="false">

                <div uib-accordion-group is-open="true" >
                  <uib-accordion-heading>
                    Training and validation
                  </uib-accordion-heading>

                  <div class="training-and-validation" >
                    <div>
                      <label class="training">Training</label>
                      <div>
                        <div ng-repeat="dataset in datasets" class="datasets-types">
                          <span class="dataset-wrap">
                            <input
                              type="checkbox"
                              id="{{dataset.code}}T"
                              class="training"
                              name="{{dataset.code}}"
                              ng-model="shared.experiment_datasets.training[dataset.code]"
                            />
                            <label for="{{dataset.code}}T">
                              <span class="code">{{dataset.label}}</span>
                            </label>
                          </span>
                        </div>
                      </div>
                    </div>
                    <div ng-if="isValidationShow">
                      <label class="validation">Validation</label>
                      <div>
                        <div ng-repeat="dataset in datasets" class="datasets-types">
                          <span ng-init="shared.experiment_datasets.validation[dataset.code] = false" class="dataset-wrap">
                            <input
                              type="checkbox"
                              id="{{dataset.code}}V"
                              class="validation"
                              name="{{dataset.code}}"
                              ng-click="shared.experiment_datasets.validation[dataset.code] = !shared.experiment_datasets.validation[dataset.code]"
                            />
                            <label for="{{dataset.code}}V">
                              <span class="code">{{dataset.label}}</span>
                            </label>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </uib-accordion>
            </div>



          <div ng-if="!shared.chosen_method">

            <div class="col-xs-12">
              <div class="panel">
                <div class="panel-heading">
                  About Running Experiments
                </div>
                <div class="panel-body">
                  An experiment is a set of algorithm(s) and their configuration applied to the variables already selected. You may choose
                  same algorithms more than once providing that you change the configuration parameters.
                  <br />
                  <br /> You can design your own MIP Experiment by doing the following:
                  <br />
                  <ol>
                    <li>Select a Machine Learning method on the left</li>
                    <li>If required, configure parameters (e.g. "k")</li>
                    <li>Add to Experiment</li>
                    <li>Optionally operate the same steps with other algorithms and/or parameters</li>
                    <li>Give a name to the Experiment</li>
                    <li>Select your k-fold Validation (to be applied to predictive model algorithms)</li>
                    <li>Run Experiment</li>
                  </ol>
                  Wait for results.
                </div>
              </div>
            </div>

          </div>

        </div>

        <div class="col-xs-3">
          <uib-accordion close-others="false">

            <div uib-accordion-group is-open="help_is_open">
              <uib-accordion-heading>
                Model
              </uib-accordion-heading>

              <div>
                <div class="variable-list scrollable">

                  <h5 ng-if="modelsList">Select model</h5>
                  <select ng-model="selectedModel"
                          ng-change="change(selectedModel)"
                          ng-options="chosenModel.title for chosenModel in modelsList"
                          class="form-control chosen-model">
                  </select>

                  <h5 ng-if="query.variables.length">Variable</h5>
                  <p ng-repeat="variable in query.variables">
                    {{variable.code}}
                  </p>

                  <h5 ng-if="query.coVariables.length || query.groupings.length">CoVariables</h5>
                  <p ng-repeat="covariable in query.groupings">
                    <span>
                      {{covariable.code}}
                    </span>
                  </p>
                  <p ng-repeat="covariable in query.coVariables">
                    <span>
                      {{covariable.code}}
                    </span>
                  </p>
                  <h5 ng-if="query.filters.length">Filters</h5>
                  <p ng-repeat="filter in query.filters">
                    <span>
                      {{filter.code}}
                    </span>
                  </p>

                </div>
              </div>
            </div>

          </uib-accordion>

          <uib-accordion close-others="false">

            <div uib-accordion-group is-open="help_is_open" ng-show="shared.chosen_method">
              <uib-accordion-heading>
                {{shared.chosen_method.label}} method
              </uib-accordion-heading>
              <div ng-if="!shared.chosen_method.description">
                There is no description for this method
              </div>
              <div ng-if="shared.chosen_method.description" btf-markdown="shared.chosen_method.description"></div>
            </div>

          </uib-accordion>
        </div>

      </div>

    </div>

  </div>

</div>
