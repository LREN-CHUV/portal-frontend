<div ng-if="!loaded">
  <div class="row">
    <div class="col-sm-6 col-sm-offset-3">
      <div class="panel">
        <div class="panel-heading">
          <h3>Please wait</h3>
        </div>
        <div class="panel-body">
          We are loading the data corresponding to your model.
        </div>
      </div>
    </div>
  </div>
</div>
<div ng-cloak ng-if="loaded">

  <div class="row">
    <div class="col-xs-12">
      <div class="panel">
        <div class="panel-heading">
          <h3 ng-if="model">
            Run an Experiment on
            <a ui-sref="models-edit({slug: model.slug, isCopy: false})" ng-bind="model.title"></a>
            <other-experiments model_slug="model.slug"></other-experiments>
          </h3>
          <h3 ng-if="!model">
            Run an Experiment on &lt;Unsaved Model&gt;
            <button class="btn btn-primary col-bottom" ng-click="save_model()">Save Model</button>
          </h3>
        </div>
      </div>

      <span ng-if="federationmode">
        <button class="btn btn-primary" ng-class="{active: mode.local.active}" ng-disabled="mode.local.disabled" ng-click="set_mode('local')">
          Local
        </button>
        <button class="btn btn-primary" ng-class="{active: !mode.local.active}" ng-disabled="mode.exareme.disabled" ng-click="set_mode('exareme')">
          Exareme
        </button>
      </span>

      <div class="row">

        <div class="col-sm-3">
          <div class="method-panel panel">
            <div class="panel-heading">
              Available Methods
            </div>
            <div class="panel-body">

              <div ng-if="!ml_methods.length">
                <h4>Note:</h4>
                <p>
                  No method available at the moment...
                </p>
              </div>

              <uib-accordion ng-if="ml_methods.length" close-others="false">
                <div uib-accordion-group heading="Predictive Model" ng-init="acc_pm.open = true" is-open="acc_pm.open" ng-click="!acc_pm.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'predictive_model'}  | orderBy:'-label'">
                    <span class="label label-default" ng-if="method.nyi">Coming soon</span>
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="shared.chosen_method = method" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>

                <div uib-accordion-group heading="Features Extraction" ng-init="acc_fe.open = true" is-open="acc_fe.open" ng-click="!acc_fe.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'features_extraction'}  | orderBy:'-label'">
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="shared.chosen_method = method" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>
                <div uib-accordion-group heading="Statistical Analysis" ng-init="acc_stats.open = true" is-open="acc_stats.open" ng-click="!acc_stats.open">
                  <p ng-repeat="method in ml_methods | filter:{type:'statistics'}  | orderBy:'-label'">
                    <button class="btn btn-primary-alt col-xs-12" ng-disabled="!method.available" ng-click="shared.chosen_method = method" ng-bind="method.label">
                    </button>
                    <br>
                    <br>
                  </p>
                </div>
              </uib-accordion>
            </div>
          </div>
        </div>

        <div class="col-sm-6">

          <!-- ng-show instead of ng-if because I don't want the inner directives to be destroyed  when unpicking the method -->
          <form class="row" ng-show="shared.chosen_method">

            <div class="col-xs-12">

              <uib-accordion close-others="false">

                  <div uib-accordion-group is-open="true">
                      <uib-accordion-heading>
                        <span class="ti ti-panel"></span>
                        Datasets
                      </uib-accordion-heading>
                      <div ng-repeat="dataset in query.datasets" class="datasets-types">
                        <label>
                            <span class="code">{{dataset.code}}</span>
                        </label>
                        <input 
                          type="checkbox"
                          class="training"
                          name="{{dataset.code}}" 
                          ng-model="shared.experiment_datasets.training[dataset.code]" 
                        />
                        <input 
                          type="checkbox" 
                          class="validation"
                          name="{{dataset.code}}"
                          ng-model="shared.experiment_datasets.validation[dataset.code]" 
                        />  
                      </div>
                  </div>


                <div uib-accordion-group is-open="true">
                  <uib-accordion-heading>
                    <span class="ti ti-panel"></span>
                    Configure The Method's Parameters
                  </uib-accordion-heading>
                  <div ng-if="shared.chosen_method.parameters.length" class="form-group">
                    <div ng-repeat="parameter in shared.chosen_method.parameters" class="form-inline">
                      <label for="{{parameter.name}}">
                        <b ng-bind="parameter.label + ': '"></b>
                      </label>
                      <div ng-switch on="parameter.type">
                        <div ng-switch-when="int">
                          <input type="number" step="1" id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value"
                            value="{{shared.method_parameters[$index].value}}" ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parseInt(parameter.default_value)}">
                        </div>
                        <div ng-switch-when="real">
                          <input type="number" step="0.1" id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value"
                            value="{{shared.method_parameters[$index].value}}" ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}">
                        </div>
                        <div ng-switch-when="enumeration">
                          <select id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value" ng-options="value for value in parameter.values"
                            ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}"></select>
                        </div>
                        <div ng-switch-default>
                          <p ng-bind="{{shared.chosen_method.parameters | json}}"></p>
                          <input id="{{parameter.name}}" class="form-control" ng-model="shared.method_parameters[$index].value" value="{{shared.method_parameters[$index].value}}"
                            ng-init="shared.method_parameters[$index] = {code: parameter.code, label: parameter.label, value: parameter.default_value}">
                        </div>
                      </div>
                      <p ng-bind="parameter.description"></p>
                    </div>
                  </div>
                  <div ng-if="!shared.chosen_method.parameters.length">
                    There are no parameters for
                    <span ng-bind="shared.chosen_method.label"></span>.
                  </div>

                  <button class="btn btn-primary pull-right" ng-class="{'disabled': method_already_configured() || configuration_not_valid() || exareme_method_disabled()}"
                    ng-click="add_to_experiment()">
                    Add to experiment
                  </button>

                </div>

                <div uib-accordion-group is-open="help_is_open">
                  <uib-accordion-heading>
                    <span class="ti ti-help-alt"></span>
                    Help
                  </uib-accordion-heading>

                  <div ng-if="!shared.chosen_method.help">
                    There is no help for this method
                  </div>
                  <div ng-if="shared.chosen_method.help" btf-markdown="shared.chosen_method.help"></div>
                </div>
              </uib-accordion>
            </div>
          </form>


          <div class="row" ng-if="!shared.chosen_method">

            <div class="col-xs-12">
              <div class="panel">
                <div class="panel-heading">
                  About Running Experiments
                </div>
                <div class="panel-body">
                  An experiment is a set of algorithm(s) and their configuration applied to the variables already selected. You may choose
                  same algorithms more than once providing that you change the configuration parameters.
                  <br />
                  <br /> You can design your own MIP Experiment by doing the following:
                  <br />
                  <ol>
                    <li>Select a Machine Learning method on the left</li>
                    <li>If required, configure parameters (e.g. "k")</li>
                    <li>Add to Experiment</li>
                    <li>Optionally operate the same steps with other algorithms and/or parameters</li>
                    <li>Give a name to the Experiment</li>
                    <li>Select your k-fold Validation (to be applied to predictive model algorithms)</li>
                    <li>Run Experiment</li>
                  </ol>
                  Wait for results.
                </div>
              </div>
            </div>

          </div>

        </div>

        <div class="col-xs-3">
          <algorithm-runner></algorithm-runner>
        </div>

      </div>

    </div>

  </div>

</div>
